@* File: Views/Stock/Move.cshtml
   Purpose: Single-card Stock In/Out confirmation page.
   i18n: Uses IViewLocalizer with Resources/Views/Stock/Move.{culture}.resx
*@
@using InventorySystem.ViewModels
@model InventorySystem.ViewModels.StockMoveVm
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["PageTitle"];
}

<div class="container py-4 move-page">
    <h2 class="move-title mb-3">@Localizer["Header"]</h2>

    <!-- 🔹 Barcode Scan / Lookup (handled by scanner.js) -->
    <form id="scanForm" class="mb-3" autocomplete="off">
        @Html.AntiForgeryToken() <!-- token for any JS POST -->
        <div class="input-group input-group-lg">
            <input id="barcodeInput" class="form-control"
                   placeholder="@Localizer["BarcodePlaceholder"]" autocomplete="off" autofocus />
            <button class="btn btn-forvia-accent" type="submit">Lookup</button>
        </div>
        <small class="move-help">@Localizer["LookupHelp"]</small>
    </form>

    <!-- 🔹 Lookup Result (info only, filled by JS) -->
    <div id="resultPanel" class="card d-none mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <div id="pName"></div>
                    <div id="pMeta"></div>
                    <div id="pSerial"></div>
                    <div class="p-info-row mt-2">
                        <span id="pBarcodeChip" class="info-chip" data-help="unique barcode"></span>
                        <span id="pLocationChip" class="info-chip" data-help="current location"></span>
                    </div>
                </div>
                <span id="pStockBadge" class="badge rounded-pill"></span>
            </div>
        </div>
    </div>

    <!-- 🔹 Single Card: Transaction Confirmation -->
    <div class="card move-card border-0">
        <div class="card-header text-white" style="background: var(--forvia-blue-grad);">
            @Localizer["ConfirmTransaction"]
        </div>
        <div class="card-body">
            <form asp-action="Confirm" asp-controller="Stock" method="post" novalidate class="row g-3" id="confirmForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <!-- Barcode -->
                <div class="col-12 col-md-6">
                    <label asp-for="Barcode" class="form-label"></label>
                    <input asp-for="Barcode" class="form-control" id="moveBarcode"
                           placeholder="@Localizer["BarcodePlaceholder"]" />
                    <span asp-validation-for="Barcode" class="text-danger small"></span>
                </div>

                <!-- Location (required) -->
                <div class="col-12 col-md-6">
                    <label class="form-label">@Localizer["LocationLabel"]</label>
                    <select asp-for="Location" class="form-select" id="moveLocation"
                            asp-items="Html.GetEnumSelectList<MoveLocation>()">
                        <option value="" disabled selected hidden>@Localizer["LocationPlaceholder"]</option>
                    </select>
                    <span class="text-muted d-block mt-1 small">@Localizer["LocationHelp"]</span>
                    <span asp-validation-for="Location" class="text-danger small"></span>
                </div>

                <!-- DeliveredBy (optional) -->
                <div class="col-12 col-md-6">
                    <label class="form-label">@Localizer["DeliveredByLabel"]</label>
                    <input asp-for="DeliveredBy" class="form-control"
                           placeholder="@Localizer["DeliveredByLabel"]" />
                    <span asp-validation-for="DeliveredBy" class="text-danger small"></span>
                </div>

                <!-- Note (optional) -->
                <div class="col-12">
                    <label class="form-label">@Localizer["NoteLabel"]</label>
                    <textarea asp-for="Note" class="form-control" rows="2"
                              placeholder="@Localizer["NoteLabel"]"></textarea>
                    <span asp-validation-for="Note" class="text-danger small"></span>
                </div>

                <div class="col-12 d-flex gap-2">
                    <button type="submit" class="btn btn-forvia-primary">
                        @Localizer["ConfirmTransaction"]
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 🔹 Hidden one-shot form used by scanner.js (kept for compatibility) -->
    <form id="formConfirm" method="post" action="/Stock/Confirm" class="d-none">
        @Html.AntiForgeryToken()
        <input name="Barcode" />
        <input name="Location" />
        <input name="DeliveredBy" />
        <input name="Note" />
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/scanner.js" asp-append-version="true"></script>
}
